name: Clone Test

on:
  workflow_dispatch:

jobs:
  clone-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH agent with deploy key
        run: |
          echo "ğŸ”§ Creating .ssh directory..."
          mkdir -p ~/.ssh

          echo "ğŸ”§ Writing private key to temp_deploy_key..."
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/temp_deploy_key
          chmod 600 ~/.ssh/temp_deploy_key

          echo "ğŸ”§ Starting ssh-agent..."
          eval "$(ssh-agent -s)"

          echo "ğŸ”§ Adding key to agent..."
          ssh-add ~/.ssh/temp_deploy_key

          echo "ğŸ”§ Verifying key fingerprint..."
          ssh-keygen -lf ~/.ssh/temp_deploy_key || echo "âŒ Failed to read key fingerprint"

          echo "ğŸ”§ Scanning GitHub host key..."
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          echo "ğŸ”§ Listing known hosts:"
          cat ~/.ssh/known_hosts

          echo "ğŸ”§ Listing loaded SSH identities:"
          ssh-add -l || echo "âŒ No identities loaded"
        env:
          SSH_AUTH_SOCK: /tmp/ssh-auth.sock

      - name: Test SSH connection to GitHub
        env:
          SSH_AUTH_SOCK: /tmp/ssh-auth.sock
        run: |
          echo "ğŸ” Testing SSH connection to GitHub..."
          ssh -T git@github.com || echo "âŒ SSH test failed"

      - name: Clone target repository
        env:
          SSH_AUTH_SOCK: /tmp/ssh-auth.sock
        run: |
          echo "ğŸ“¦ Attempting to clone repository..."
          git clone git@github.com:Dmitrii-Zavalin-Deployments/engineering_simulations_pipeline_domain_grid_sred.git || echo "âŒ Git clone failed"



